% Edgar Fournival <contact@edgar-fournival.fr>

\documentclass[11pt,a4paper]{article}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}

\usepackage[english]{babel}

\usepackage{ifxetex}

\ifxetex
  \usepackage{fontspec}
\else
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\fi

\setlength\parindent{0pt}
\setlength\parskip{0.25em}

\let\emptyset\varnothing
\let\leq\leqslant
\let\geq\geqslant

\usepackage{xspace}
\newcommand{\rpi}{Raspberry Pi\xspace}

\usepackage{etoolbox}
\makeatletter
\preto{\@verbatim}{\topsep=0.25em \partopsep=0.25em }
\makeatother

\newcommand{\plugmodule}[2]{Plug the \texttt{#1} pin into the \texttt{#2} pin of the GPIO extension board.}
\newcommand{\plugcolumn}[4]{Plug a {#1\def\temp{#1}\ifx\temp\empty\else\ \fi}cable between the \texttt{#2} pin and the \texttt{#3} column on the #4.}

\begin{document}

Edgar Fournival \hfill M2 COMASIC

\begin{center}
  \medskip
  \huge\textbf{Project report: Internet of Things}
  \medskip
\end{center}

\section*{Introduction}

\section{Setup}

\subsection{Networking}

During the development and the testing of the project, I used an Ethernet cable with a static networking configuration.

The \rpi, my home computer and the Internet connection were all connected to a Dlink switch.

In order to define a non-volatile network configuration on the \rpi, the file \texttt{/etc/network/\allowbreak interfaces} was edited by adding the following instructions:
\begin{verbatim}
iface eth0 inet static
  address 192.168.1.11
  netmask 255.255.255.0
  gateway 192.168.1.1
\end{verbatim}

My Internet connection is backed by an Orange Livebox which is on a 192.168.1.0/24 network. It supports DHCP but I preferred to give the \rpi a static configuration in order to ease the configuration of the SSH link between the devices.

\subsection{SSH}

SSH is a secure transport protocol designed to replace Telnet. It can be used to send commands to a remote device or setup things such as port forwarding, encrypted tunnels, etc. I have decided to setup SSH on the \rpi in order to drop the need to use the QWERTY keyboard, the mouse and another screen.

The SSH server service has been enabled on the \rpi, meaning it will start during the boot. This has been achieved with this command:
\begin{verbatim}
sudo systemctl enable ssh
\end{verbatim}

After that, I created a new SSH key on my home computer without a passphrase using \texttt{ssh-keygen} with its default options. The key was then sent to the \rpi using:
\begin{verbatim}
ssh-copy-id -i ~/.ssh/rpi pi@192.168.1.11
\end{verbatim}

To make things easier, I also defined a SSH alias in \verb|~/.ssh/config|:
\begin{verbatim}
Host rpi
  IdentityFile ~/.ssh/rpi
  User pi
  HostName 192.168.1.11
\end{verbatim}

This allowed me to connect to the \rpi under the alias \texttt{rpi} and without providing a password. From now I can type directly \texttt{ssh rpi} or use \texttt{rpi} in the \texttt{rsync} or \texttt{scp} commands.

\subsection{Hardware}

\subsubsection{The basics}

\begin{enumerate}
  \item	Open the \rpi in order to access the GPIO pins.
  \item	Plug the GPIO ``rainbow pride'' cable to the \rpi.
  \item	Plug the GPIO extension board to the other end of the GPIO cable.
  \item	Plug the GPIO extension board into the middle of the breadboard.
  \item	\plugcolumn{red}{3V3}{+}{left}
  \item	\plugcolumn{black}{GND}{-}{left}
\end{enumerate}

\subsubsection{RGB LED module}

\begin{enumerate}
  \item	\plugcolumn{}{VCC}{3V3 +}{left}
  \item	\plugmodule{R}{GPIO17}
  \item	\plugmodule{G}{GPIO18}
  \item	\plugmodule{B}{GPIO27}
\end{enumerate}

\subsubsection{PCF8591 module}

\begin{enumerate}
  \item	\plugcolumn{}{VCC}{3V3 +}{left}
  \item \plugcolumn{}{GND}{3V3 -}{left}
  \item	\plugmodule{SDA}{SDA1}
  \item	\plugmodule{SCL}{SCL1}
  \item Plug a 4-pins female cable into the \texttt{AIN0}, \texttt{AIN1}, \texttt{AIN2} and \texttt{AIN3} of the module.
  \item Plug the other end of the cable into unused lines on the breadboard.
\end{enumerate}

\subsubsection{Thermistor}

\begin{enumerate}
  \item	\plugcolumn{}{VCC}{3V3 +}{left}
  \item \plugcolumn{}{GND}{3V3 -}{left}
  \item Plug a cable between the \texttt{SIG} pin and \texttt{AIN0} from the PCF8591 on the breadboard.
\end{enumerate}

\subsubsection{Photoresistor}

\begin{enumerate}
  \item	\plugcolumn{}{VCC}{3V3 +}{left}
  \item \plugcolumn{}{GND}{3V3 -}{left}
  \item	Plug a cable between the \texttt{SIG} pin and \texttt{AIN1} from the PCF8591 on the breadboard.
\end{enumerate}

\subsubsection{Humiture sensor}

\begin{enumerate}
  \item	\plugmodule{VCC}{5V0}
  \item \plugmodule{GND}{GND}
  \item	\plugmodule{SIG}{GPIO22}
\end{enumerate}

\subsection{Software}

First, we need to update the package cache in order to be able to install new packages:
\begin{verbatim}
sudo apt-get update
\end{verbatim}

\subsubsection{The Go toolchain}

Then, we will need the Go toolchain for local testing. The package available in Raspbian is too old, so here is the command for the last release:
\begin{verbatim}
wget https://dl.google.com/go/go1.10.linux-armv6l.tar.gz
sudo tar -C /usr/local -xzf go1.10.linux-armv6l.tar.gz
echo "export PATH=$PATH:/usr/local/go/bin" >> ~/.bashrc
\end{verbatim}

After that, we need to setup Go environment in a specific folder and permanently export the \texttt{GOPATH} environment variable:
\begin{verbatim}
sudo su -
mkdir -p ~/go
echo "export GOPATH=~/go" >> ~/.bashrc
source ~/.bashrc
\end{verbatim}

Note we are doing this with the \texttt{root} user because only the superuser can play with PWM (used by the RGB LED).

\subsubsection{Cloning the repository}

Git is already installed on the \rpi. We will use it to clone the repository of my project hosted on GitHub.

Note that the repository must be cloned in \verb|$GOPATH| in order to be able to use \texttt{go get}:
\begin{verbatim}
sudo su -
export IOTDIR=$GOPATH/src/github.com/efournival
mkdir -p $IOTDIR && cd $IOTDIR
git clone https://github.com/efournival/iot-project.git
cd iot-project
\end{verbatim}

\subsubsection{Enabling the I2C bus}

The I2C bus is used by the PCF8591 analog-to-digital converter in order to read the temperature from the thermistor.

First, connect to the device using SSH (for example, \texttt{ssh rpi}) and run the configuration utility:
\begin{verbatim}
sudo raspi-config
\end{verbatim}

Then:
\begin{enumerate}
  \item Enter \texttt{9 Advanced Options}.
  \item Enter \texttt{A6 I2C}.
  \item Answer ``yes'' to the question ``Would you like the ARM I2C interface to be enabled?''.
  \item Wait for the confirmation then quit with the escape key.
\end{enumerate}

The device driver should now be available under \texttt{/dev}, you can quickly check by running \texttt{ls /dev/i2c-1}.

\section*{Conclusion}

%il faut expliquer l'architecture avec des flèches, en détails
%par exemple :
%ordinateur
%rpi, capteurs
%sockets, direction des flux
%activateurs (lampe, alarme, ...)
%serveurs, stockage

\end{document}
